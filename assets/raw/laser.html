<html>
<head>
<script src="../../libs/tmlib.js"></script>
<script>
tm.preload(function() {
    tm.addLoadCheckList(tm.asset.AssetManager);

    tm.asset.AssetManager.load("laser", "laser.png");
    // tm.asset.AssetManager.load("laser", "dummy.png");
    for (var i = 0; i < 8; i++) {
        tm.asset.AssetManager.load("r" + i, "r" + i + ".png");
    }
    tm.asset.AssetManager.load("fighter", "fighter4.png");
});
tm.main(function() {
    var canvas = tm.graphics.Canvas("#c");
    tm.dom.Element("#c").event.click(function() {
        canvas.saveAsImage();
    });
    canvas.resize(64, 240); //.fitWindow();
    canvas.globalCompositeOperation = "lighter";
    for (var i = 0; i < 240+40; i++) {
        var t = (Math.PI*2)/240 * i;
        canvas.fillStyle = tm.graphics.RadialGradient(32, i-20, 0, 32, i-20, 20).addColorStopList([
            { offset: 0.00, color: "rgba(180, 100, 50, 0.2)" },
            { offset: 0.30+Math.sin(t)*0.2, color: "rgba(180, 100, 50, 0.1)" },
            { offset: 1.00, color: "rgba(255, 200, 0, 0.0)" },
        ]).toStyle();
        canvas.fillRect(0, i-40, 64, 40);
    }

    var x = 160;
    var y = 350;

    var laser = Laser("laser", Array.range(0, 8).map(function(v) { return "r" + v }));
    laser.x = x;
    laser.y = y;

    var c = tm.app.Sprite("fighter", 64, 64);
    c.x = x;
    c.y = y + 48;

    var app = tm.app.CanvasApp("#app");
    app.resize(320, 480);
    app.background = "rgba(0,0,50,1)";
    app.update = function() {
        if (this.keyboard.getKey("up")) {
            laser.y -= 3;
            c.y -= 3;
        } else if (this.keyboard.getKey("down")) {
            laser.y += 3;
            c.y += 3;
        }
        if (this.keyboard.getKey("left")) {
            laser.x -= 3;
            c.x -= 3;
        } else if (this.keyboard.getKey("right")) {
            laser.x += 3;
            c.x += 3;
        }
    };

    app.currentScene.addChild(c);
    app.currentScene.addChild(laser);

    app.run();
});

var Laser = tm.createClass({
    superClass: tm.app.CanvasElement,
    image: null,
    c: null,
    age: 0,
    hitY: 30,
    rt: null,
    init: function(texture, roots) {
        var tex = tm.asset.AssetManager.get(texture);
        this.rt = roots.map(function(name) {
            return tm.asset.AssetManager.get(name);
        });
        this.rt.index = 0;
        this.rt.next = function() {
            this.index = (this.index + 1) % this.length;
            return this[this.index];
        };

        this.superInit();
        this.image = tex.element;
        this.width = tex.width;
        this.height = 480;
        this.blendMode = "lighter";
        this.origin.y = 1;

        this.c = tm.graphics.Canvas();
        this.c.resize(this.width, this.height);
        this.c.globalCompositeOperation = "lighter";
    },
    update: function(app) {
        this.age += 1;
    },
    draw: function(canvas) {
        var y = (this.age*30) % 240;
        this.c.clear();
        for (var i = 0; i < 3; i++) {
            this.c.drawImage(this.image, 0, -y + 240*i);
        }

        this.height = this.y - this.hitY;
        canvas.context.drawImage(this.c.element,
            0, this.c.height-this.height, this.c.width, this.height,
            -this.width*this.origin.x, -this.height*this.origin.y, this.width, this.height);
        canvas.context.drawImage(this.rt.next().element, -64, -32);
    }
})
</script>
</head>
<body>
<canvas id="c"></canvas>
<canvas id="app"></canvas>
</body>
</html>
