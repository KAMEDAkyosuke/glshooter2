<html>
<head>
<script src="../../libs/tmlib.js"></script>
<script>
tm.preload(function() {
    tm.asset.AssetManager.load("laser", "laser.png");
    for (var i = 0; i < 3; i++) {
        tm.asset.AssetManager.load("r" + i, "r" + i + ".png");
    }
});
tm.main(function() {
    var canvas = tm.graphics.Canvas("#c");
    tm.dom.Element("#c").event.click(function() {
        canvas.saveAsImage();
    });

    canvas.resize(64, 240); //.fitWindow();
    canvas.globalCompositeOperation = "lighter";

    for (var i = 0; i < 240+40; i++) {
        var t = (Math.PI*2)/240 * i;
        canvas.fillStyle = tm.graphics.RadialGradient(32, i-20, 0, 32, i-20, 20).addColorStopList([
            { offset: 0.00, color: "rgba(150, 200, 255, 0.2)" },
            { offset: 0.30+Math.sin(t)*0.1, color: "rgba(150, 200, 255, 0.1)" },
            { offset: 1.00, color: "rgba(0, 0, 255, 0.0)" },
        ]).toStyle();
        canvas.fillRect(0, i-40, 64, 40);
    }

    var x = 160;
    var y = 350;

    var laser = Laser(tm.asset.AssetManager.get("laser"), 64, 480);
    laser.x = x;
    laser.y = y;

    var c = tm.app.CircleShape(10, 10);
    c.x = x;
    c.y = y;

    var app = tm.app.CanvasApp("#app");
    app.resize(320, 480);
    app.update = function() {
        if (this.keyboard.getKey("up")) {
            laser.y -= 3;
            c.y -= 3;
        } else if (this.keyboard.getKey("down")) {
            laser.y += 3;
            c.y += 3;
        }
    };

    app.currentScene.addChild(laser);
    app.currentScene.addChild(c);

    app.run();
});

var Laser = tm.createClass({
    superClass: tm.app.CanvasElement,
    texture: null,
    image: tm.graphics.Canvas().resize(64, 480),
    width: 0,
    height: 0,
    age: 0,
    hitY: 30,
    init: function(tex, w, h) {
        this.superInit();
        this.width = w;
        this.height = h;
        this.texture = tex;
        this.blendMode = "lighter";
        this.image.globalCompositeOperation = "lighter";
    },
    update: function(app) {
        this.age += 1;
        this.image.clear();
        this.image.drawTexture(this.texture, 0, 120);
    },
    draw: function(canvas) {
        canvas.context.drawImage(this.image.element,
            -this.width*this.origin.x, this.hitY - this.y, this.width, this.y - this.hitY);
    }
})
</script>
</head>
<body>
<canvas id="c"></canvas>
<canvas id="app"></canvas>
</body>
</html>
