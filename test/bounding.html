<html>
<head>
<meta charset=UTF-8>
<script src="../libs/tmlib.js"></script>
<script>
tm.main(function() {
    var app = tm.app.CanvasApp("#app").resize(300, 300);
    app.fps = 60;
    var scene = app.currentScene;

    var fighter = tm.app.TriangleShape(20, 20).setPosition(150, 280).addChildTo(scene);
    fighter.update = function(app) {
        var kb = app.keyboard;
        if (kb.getKey("left")) this.x -= 5;
        else if (kb.getKey("right")) this.x += 5;
        if (kb.getKey("up")) this.y -= 5;
        else if (kb.getKey("down")) this.y += 5;

        if (kb.getKeyDown("space") && !shot.active) {
            shot.setPosition(this.x, this.y).addChildTo(this.parent);
        }
    }

    var shot = tm.app.CircleShape(10, 10, {
        strokeStyle: "transparent",
        fillStyle: "red",
    });
    shot.radius = 5;
    shot.active = false;
    shot.update = function() {
        this.y -= 2;
        if (this.y < -10) {
            this.remove();
        }
    };
    shot.onadded = function() {
        this.active = true;
    }
    shot.onremoved = function() {
        this.active = false;
    };

    var enemy = tm.app.RectangleShape(50, 50, {
        strokeStyle: "transparent",
        fillStyle: "white",
    }).setPosition(150, 60).addChildTo(scene);
    enemy.boundingType = "rect";
    enemy.getBoundingRect = function() {
        return tm.geom.Rect(this.x - 25, this.y - 25, 50, 50);
    };
    enemy.update = function(app) {
        if (this.isHitElement(p)) {
            this.alpha = app.frame % 2 ? 0.5: 0.2;
            p.hitY = this.y + 25 - 1;
        } else {
            p.hitY = -50;
            this.alpha = 1;
        }
    }

    var texture = tm.asset.Texture("../assets/laser_b.png");
    var ht = tm.asset.Texture("../assets/laser_b_head.png");
    var ft = tm.asset.Texture("../assets/laser_b_foot.png");
    var at = tm.asset.Texture("../assets/aura.png");

    var p = Laser(texture, ht, ft, at, 40)
        .setPosition(200, 150)
        .addChildTo(scene);
    p.onenterframe = function(app) {
        this.setPosition(fighter.x, fighter.y);
    }
    p.hitY = -50;

    app.run();
});

var Laser = tm.createClass({
    superClass: tm.app.Sprite,

    hitY: 0,
    frame: 0,

    init: function(texture, headTexture, footTexture, auraTexture, width) {
        this.superInit(texture, width, 100);

        this.boundingType = "rect";

        this.scrollOffset = 0;
        this.origin.y = 1.0;
        // this.blendMode = "lighter";

        this.srcRect.x = 0;
        this.srcRect.y = 0;
        this.srcRect.width = texture.width / 16;

        var h = tm.app.AnimationSprite(tm.app.SpriteSheet({
            image: headTexture,
            frame: {
                width: 80,
                height: 80
            },
            animations: {
                "anim": {
                    frames: [0, 1, 2, 3],
                    next: "anim",
                    frequency: 2,
                }
            }
        }), 120, 120);
        h.gotoAndPlay("anim");
        h.addChildTo(this);
        var self = this;
        h.update = function() {
            this.y = self.hitY - self.y;
        };
        // h.blendMode = "lighter";

        var f = tm.app.AnimationSprite(tm.app.SpriteSheet({
            image: footTexture,
            frame: {
                width: 128,
                height: 64
            },
            animations: {
                "anim": {
                    frames: [0, 1, 2, 3],
                    next: "anim",
                    frequency: 2,
                }
            }
        }), 96, 48);
        f.gotoAndPlay("anim");
        f.blendMode = "lighter";
        f.addChildTo(this);

        var a = tm.app.AnimationSprite(tm.app.SpriteSheet({
            image: auraTexture,
            frame: {
                width: 100,
                height: 100
            },
            animations: {
                "anim": {
                    frames: [2, 6, 10, 14],
                    next: "anim",
                    frequency: 2,
                }
            }
        }), 80, 80);
        a.y = 30;
        a.gotoAndPlay("anim");
        a.blendMode = "lighter";
        a.addChildTo(this);
    },

    update: function(app) {
        this.height = this.position.y - this.hitY;
        if (app.frame % 3 === 0) this.frame = (this.frame + 1) % 16;
    },

    getBoundingRect: function() {
        return tm.geom.Rect(this.x - this.width/2, this.y - this.height, this.width, this.height);
    },

    draw: function(canvas) {
        var srcRect = this.srcRect;
        var element = this._image.element;

        srcRect.x = srcRect.width * this.frame;

        canvas.context.drawImage(element,
            srcRect.x, srcRect.height - this.height, srcRect.width, this.height,
            -this.width*this.origin.x, -this.height*this.origin.y, this.width, this.height);
    },

});

</script>
</head>
<body>
<canvas id="app"></canvas>
</body>
</html>